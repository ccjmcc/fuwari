# 访问量和访客数配置说明

## 📊 功能说明

博客使用 **Umami** 统计服务来显示：
- **全站访问量**：显示在侧边栏的个人资料卡片中
- **全站访客数**：显示在侧边栏的个人资料卡片中
- **单篇文章访问量**：显示在文章页面的元数据中
- **单篇文章访客数**：显示在文章页面的元数据中

## 🔧 配置步骤

### 1. 配置 Umami 统计服务

编辑文件：`src/config.ts`

找到 `umamiConfig` 配置项（约第143-148行）：

```typescript
export const umamiConfig: UmamiConfig = {
	enable: false, // 设置为 false 禁用 Umami 统计，需要时改为 true 并配置相应参数
	baseUrl: "https://umami.acofork.com",
	shareId: "CdkXbGgZr6ECKOyK",
	timezone: "Asia/Shanghai",
};
```

#### 配置参数说明：

- **`enable`**：是否启用 Umami 统计
  - `true`：启用统计功能
  - `false`：禁用统计功能（默认值）

- **`baseUrl`**：你的 Umami 实例地址
  - 如果你使用自建的 Umami，填写你的 Umami 服务地址
  - 例如：`"https://umami.yourdomain.com"`
  - 注意：不要以 `/` 结尾

- **`shareId`**：Umami 分享链接的 ID
  - 在 Umami 后台创建"分享链接"后获取
  - 分享链接格式：`https://umami.yourdomain.com/share/xxxxx`
  - 其中 `xxxxx` 就是 `shareId`

- **`timezone`**：时区设置
  - 中国用户使用：`"Asia/Shanghai"`
  - 其他时区请参考 [时区列表](https://en.wikipedia.org/wiki/List_of_tz_database_time_zones)

### 2. 配置 Umami 追踪脚本

编辑文件：`src/layouts/Layout.astro`

找到 Umami 追踪脚本（约第232行）：

```html
<!-- Umami分析（自建） -->
<script defer src="https://umami.acofork.com/script.js" data-website-id="5d710dbd-3a2e-43e3-a553-97b415090c63" data-swup-ignore-script></script>
```

#### 修改说明：

- **`src`**：改为你的 Umami 实例的脚本地址
  - 格式：`https://你的umami域名/script.js`
  - 例如：`https://umami.yourdomain.com/script.js`

- **`data-website-id`**：你的网站 ID
  - 在 Umami 后台创建网站后获取
  - 在 Umami 后台 → 设置 → 网站 → 查看网站 ID

### 3. 如何获取 Umami 配置信息

#### 方法一：使用自建 Umami 实例

1. **部署 Umami**
   - 参考 [Umami 官方文档](https://umami.is/docs)
   - 可以使用 Docker、Vercel、Railway 等平台部署

2. **创建网站**
   - 登录 Umami 后台
   - 点击"添加网站"
   - 填写网站信息，获取 `website-id`

3. **创建分享链接**
   - 在网站设置中创建"分享链接"
   - 获取分享链接的 `shareId`
   - 分享链接格式：`https://你的umami域名/share/shareId`

#### 方法二：使用公共 Umami 服务

如果你有可用的公共 Umami 服务，直接使用其提供的配置信息即可。

## 📝 完整配置示例

### 示例 1：启用自建 Umami

```typescript
// src/config.ts
export const umamiConfig: UmamiConfig = {
	enable: true,
	baseUrl: "https://umami.yourdomain.com",
	shareId: "your-share-id-here",
	timezone: "Asia/Shanghai",
};
```

```html
<!-- src/layouts/Layout.astro -->
<script defer src="https://umami.yourdomain.com/script.js" data-website-id="your-website-id-here" data-swup-ignore-script></script>
```

### 示例 2：禁用统计功能

```typescript
// src/config.ts
export const umamiConfig: UmamiConfig = {
	enable: false,
	baseUrl: "https://umami.acofork.com",
	shareId: "CdkXbGgZr6ECKOyK",
	timezone: "Asia/Shanghai",
};
```

当 `enable: false` 时，访问量和访客数会显示为 `0`，不会发送任何统计请求。

## 🎯 显示位置

### 1. 侧边栏统计（全站数据）

位置：`src/components/widget/Profile.astro`

显示内容：
- **访问量**：全站总访问量
- **访客数**：全站总访客数

### 2. 文章页面统计（单篇文章数据）

位置：`src/components/PostMeta.astro`

显示内容：
- **访问量**：该文章的访问次数
- **访客数**：访问该文章的独立访客数

## 🔍 工作原理

1. **数据收集**：Umami 追踪脚本在页面加载时自动收集访问数据
2. **数据获取**：通过 `fetchUmamiStats` 函数从 Umami API 获取统计数据
3. **数据缓存**：统计数据会被缓存 1 小时，减少 API 请求
4. **动画显示**：统计数据以动画形式从 0 递增到实际数值

## ⚠️ 注意事项

1. **隐私保护**：Umami 是开源的隐私友好型统计工具，不会收集用户个人信息
2. **CORS 配置**：如果使用自建 Umami，确保配置了正确的 CORS 策略
3. **API 限制**：注意 Umami API 的请求频率限制
4. **时区设置**：确保时区设置正确，否则统计数据可能不准确

## 🐛 故障排查

### 问题：访问量和访客数显示为 0

**可能原因：**
1. `umamiConfig.enable` 设置为 `false`
2. Umami 服务地址配置错误
3. `shareId` 或 `website-id` 配置错误
4. Umami 服务未正常运行
5. 浏览器控制台有 CORS 错误

**解决方法：**
1. 检查 `src/config.ts` 中的 `umamiConfig.enable` 是否为 `true`
2. 检查 Umami 服务是否正常运行
3. 打开浏览器开发者工具（F12），查看控制台是否有错误信息
4. 检查网络请求，确认 API 调用是否成功

### 问题：统计数据不更新

**可能原因：**
1. 数据缓存未过期（缓存时间为 1 小时）
2. Umami 服务延迟

**解决方法：**
1. 等待缓存过期后自动更新
2. 清除浏览器缓存或使用无痕模式测试

## 📚 相关文件

- `src/config.ts` - Umami 配置文件
- `src/components/widget/Profile.astro` - 侧边栏统计显示
- `src/components/PostMeta.astro` - 文章页面统计显示
- `public/js/umami-share.js` - Umami API 调用函数
- `src/layouts/Layout.astro` - Umami 追踪脚本引入

## 🔗 相关链接

- [Umami 官方文档](https://umami.is/docs)
- [Umami GitHub](https://github.com/umami-software/umami)
- [Umami 部署指南](https://umami.is/docs/install)
